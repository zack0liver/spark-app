<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Spark">
<meta name="theme-color" content="#F59E0B">
<meta name="mobile-web-app-capable" content="yes">
<title>Spark</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='none'><path d='M50 10 C52 28,68 33,75 50 C77 60,68 73,50 85 C32 73,23 60,25 50 C32 33,48 28,50 10Z' fill='%23F97316' opacity='0.9'/><path d='M50 22 C51 33,60 37,64 48 C65 54,60 63,50 72 C40 63,35 54,36 48 C40 37,49 33,50 22Z' fill='%23FCD34D'/></svg>">
<style>
  :root {
    --gold: #F59E0B;
    --gold-light: #FCD34D;
    --orange: #F97316;
    --pink: #EC4899;
    --pink-light: #F9A8D4;
    --cream: #FFFBF0;
    --cream-dark: #FEF3C7;
    --text-primary: #1C1917;
    --text-secondary: #78716C;
    --text-muted: #A8A29E;
    --white: #FFFFFF;
    --red: #EF4444;
    --red-light: #FEE2E2;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    --radius: 16px;
    --radius-sm: 10px;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--cream);
    color: var(--text-primary);
    min-height: 100dvh;
    overflow: hidden;
    position: fixed;
    width: 100%;
  }

  /* ── Auth Gate ── */
  .auth-gate {
    position: fixed; inset: 0; z-index: 100;
    background: linear-gradient(145deg, var(--gold-light), var(--orange), var(--pink));
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 2rem;
    transition: opacity 0.4s, transform 0.4s;
  }
  .auth-gate.hidden { opacity: 0; pointer-events: none; transform: scale(1.05); }

  .auth-logo {
    width: 100px; height: 100px;
    margin-bottom: 1.5rem;
    animation: float 3s ease-in-out infinite;
  }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  .auth-gate h1 {
    font-size: 2.5rem; font-weight: 800; color: var(--white);
    margin-bottom: 0.5rem; letter-spacing: -0.5px;
  }
  .auth-gate p {
    font-size: 1.1rem; color: rgba(255,255,255,0.85);
    margin-bottom: 2.5rem; text-align: center;
  }

  .google-btn {
    display: flex; align-items: center; gap: 12px;
    background: var(--white); color: var(--text-primary);
    border: none; border-radius: 50px; padding: 14px 32px;
    font-size: 1.05rem; font-weight: 600; cursor: pointer;
    box-shadow: var(--shadow-lg);
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .google-btn:active { transform: scale(0.96); box-shadow: var(--shadow-sm); }
  .google-btn svg { width: 22px; height: 22px; flex-shrink: 0; }

  /* ── App Shell ── */
  .app { display: none; flex-direction: column; height: 100dvh; overflow: hidden; width: 100%; }
  .app.active { display: flex; }

  /* Header */
  .header {
    background: linear-gradient(135deg, var(--gold), var(--orange), var(--pink));
    padding: calc(var(--safe-top) + 12px) 20px 14px;
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
  }
  .header-left { display: flex; align-items: center; gap: 8px; }
  .header-logo { width: 28px; height: 28px; }
  .header h1 { font-size: 1.25rem; font-weight: 700; color: var(--white); }
  .header-right { display: flex; align-items: center; gap: 8px; }

  .sign-out-btn {
    background: rgba(255,255,255,0.2); border: none; border-radius: 8px;
    color: var(--white); font-size: 0.75rem; padding: 6px 10px;
    cursor: pointer; font-weight: 600;
  }
  .sign-out-btn:active { background: rgba(255,255,255,0.35); }

  /* View Toggle — hidden, swipe only */

  /* Views Container */
  .views-container {
    flex: 1; display: flex; overflow: hidden; position: relative;
    width: 100%; max-width: 100vw;
  }
  .views-slider {
    display: flex; width: 300%; min-width: 300%; height: 100%;
    transform: translateX(-33.333%);
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .views-slider.swiping { transition: none; }

  .view {
    width: 33.333%; min-width: 33.333%; height: 100%; overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  /* ── Capture View ── */
  .capture-view {
    display: flex; flex-direction: column;
    padding: 0 20px calc(var(--safe-bottom) + 16px);
    height: 100%;
  }

  .capture-spacer-top { flex: 1; min-height: 12px; }
  .capture-spacer-bottom { flex: 1; min-height: 12px; }

  .capture-prompt {
    font-size: 1.5rem; font-weight: 700; color: var(--text-primary);
    text-align: center; margin-bottom: 16px;
  }
  .capture-prompt span {
    background: linear-gradient(135deg, var(--gold), var(--orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .capture-middle {
    width: 100%;
    display: flex; flex-direction: column;
  }

  .idea-input {
    width: 100%; height: 42dvh; min-height: 160px; max-height: 55dvh;
    border: 2px solid var(--cream-dark); border-radius: var(--radius);
    padding: 16px; font-size: 1.05rem; font-family: inherit;
    background: var(--white); color: var(--text-primary);
    resize: none; outline: none;
    box-shadow: var(--shadow-sm);
    transition: border-color 0.2s, box-shadow 0.2s;
    line-height: 1.5;
  }
  .idea-input:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15);
  }
  .idea-input::placeholder { color: var(--text-muted); }

  .char-count {
    font-size: 0.8rem; color: var(--text-muted); text-align: right;
    margin-top: 6px;
  }

  .save-btn {
    width: 100%; height: 52px;
    border: none; border-radius: 50px; cursor: pointer;
    background: linear-gradient(135deg, var(--gold), var(--orange));
    color: var(--white); font-size: 1.1rem; font-weight: 700;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    box-shadow: var(--shadow-md);
    transition: transform 0.15s, box-shadow 0.15s;
    position: relative; overflow: hidden;
    margin-top: 14px;
  }
  .save-btn:active { transform: scale(0.96); box-shadow: var(--shadow-sm); }
  .save-btn:disabled { opacity: 0.5; pointer-events: none; }
  .save-btn svg { width: 22px; height: 22px; }

  .save-btn.saving { animation: bounce-save 0.4s; }
  @keyframes bounce-save {
    0%, 100% { transform: scale(1); }
    40% { transform: scale(1.08); }
    70% { transform: scale(0.95); }
  }

  .capture-bottom {
    display: flex; flex-direction: column; align-items: center;
    gap: 6px; flex-shrink: 0;
    padding-bottom: 8px;
  }

  .mic-btn {
    width: 56px; height: 56px; border-radius: 50%;
    border: 2px solid var(--cream-dark);
    background: var(--white); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s;
    position: relative; overflow: visible;
  }
  .mic-btn svg { width: 24px; height: 24px; color: var(--text-secondary); transition: color 0.2s; }
  .mic-btn:active { transform: scale(0.93); }
  .mic-btn.recording {
    border-color: var(--red);
    background: var(--red-light);
    animation: mic-pulse 1.5s ease-in-out infinite;
  }
  .mic-btn.recording svg { color: var(--red); }
  @keyframes mic-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.3); }
    50% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
  }

  .mic-btn.unsupported { opacity: 0.35; pointer-events: none; }

  .mic-label {
    font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.5px;
  }

  /* ── Spark Burst Particles ── */
  .spark-burst {
    position: fixed; pointer-events: none; z-index: 200;
  }
  .spark-particle {
    position: absolute; border-radius: 50%;
    animation: spark-fly 0.7s ease-out forwards;
  }
  @keyframes spark-fly {
    0% { opacity: 1; transform: translate(0, 0) scale(1); }
    100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
  }

  /* ── Save Success Overlay ── */
  .save-success {
    position: fixed; inset: 0; z-index: 250;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(255, 251, 240, 0.95);
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
  }
  .save-success.show { opacity: 1; pointer-events: auto; }
  .save-success.fade-out { opacity: 0; transition: opacity 0.5s ease-in; }

  .success-icon {
    width: 80px; height: 80px;
    transform: scale(0);
  }
  .save-success.show .success-icon {
    animation: success-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }
  @keyframes success-pop {
    0% { transform: scale(0) rotate(-20deg); }
    60% { transform: scale(1.15) rotate(5deg); }
    100% { transform: scale(1) rotate(0); }
  }

  .success-text {
    margin-top: 16px; font-size: 1.3rem; font-weight: 700;
    background: linear-gradient(135deg, var(--gold), var(--orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    opacity: 0;
  }
  .save-success.show .success-text {
    animation: success-text-in 0.4s 0.25s ease-out forwards;
  }
  @keyframes success-text-in {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .capture-middle { transition: opacity 0.25s, transform 0.25s; }
  .capture-middle.reset {
    opacity: 0; transform: translateY(10px);
  }
  .capture-middle.reset-in {
    opacity: 0; transform: translateY(-10px);
    transition: none;
  }
  .capture-middle.reset-done {
    opacity: 1; transform: translateY(0);
    transition: opacity 0.35s ease-out, transform 0.35s ease-out;
  }

  /* ── Timeline River View ── */
  .timeline-view {
    padding: 24px 16px calc(var(--safe-bottom) + 20px);
    position: relative;
  }

  .timeline-header {
    text-align: center; margin-bottom: 24px;
  }
  .timeline-header h2 {
    font-size: 1.3rem; font-weight: 700; color: var(--text-primary);
  }
  .timeline-header p {
    font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;
  }

  .timeline-river {
    position: relative;
    padding: 0 8px;
    transform-origin: top center;
    transition: transform 0.05s linear;
  }

  /* Central flowing line */
  .timeline-river::before {
    content: '';
    position: absolute;
    left: 50%; top: 0; bottom: 0;
    width: 3px;
    background: linear-gradient(to bottom, var(--gold-light), var(--orange), var(--pink), var(--gold-light));
    border-radius: 3px;
    transform: translateX(-50%);
  }

  .timeline-item {
    display: flex;
    margin-bottom: 20px;
    position: relative;
    animation: timeline-in 0.4s ease-out both;
  }
  .timeline-item:nth-child(odd) { flex-direction: row-reverse; }

  @keyframes timeline-in {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* The dot on the center line */
  .timeline-dot {
    position: absolute;
    left: 50%; top: 16px;
    width: 12px; height: 12px;
    border-radius: 50%;
    transform: translateX(-50%);
    z-index: 2;
    box-shadow: 0 0 0 3px var(--cream);
  }
  .timeline-item:nth-child(5n+1) .timeline-dot { background: var(--gold); }
  .timeline-item:nth-child(5n+2) .timeline-dot { background: var(--orange); }
  .timeline-item:nth-child(5n+3) .timeline-dot { background: var(--pink); }
  .timeline-item:nth-child(5n+4) .timeline-dot { background: var(--gold-light); }
  .timeline-item:nth-child(5n+5) .timeline-dot { background: #FB923C; }

  .timeline-card {
    width: calc(50% - 20px);
    background: var(--white);
    border-radius: var(--radius-sm);
    padding: 12px 14px;
    box-shadow: var(--shadow-sm);
    position: relative;
  }

  /* Arrow pointing to center line */
  .timeline-card::after {
    content: '';
    position: absolute;
    top: 14px;
    width: 0; height: 0;
    border: 6px solid transparent;
  }
  .timeline-item:nth-child(even) .timeline-card::after {
    right: -12px;
    border-left-color: var(--white);
  }
  .timeline-item:nth-child(odd) .timeline-card::after {
    left: -12px;
    border-right-color: var(--white);
  }

  /* Color accent on top of card */
  .timeline-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 3px; border-radius: var(--radius-sm) var(--radius-sm) 0 0;
  }
  .timeline-item:nth-child(5n+1) .timeline-card::before { background: var(--gold); }
  .timeline-item:nth-child(5n+2) .timeline-card::before { background: var(--orange); }
  .timeline-item:nth-child(5n+3) .timeline-card::before { background: var(--pink); }
  .timeline-item:nth-child(5n+4) .timeline-card::before { background: var(--gold-light); }
  .timeline-item:nth-child(5n+5) .timeline-card::before { background: #FB923C; }

  .timeline-card-text {
    font-size: 0.88rem; line-height: 1.45;
    color: var(--text-primary);
    white-space: pre-wrap; word-break: break-word;
    display: -webkit-box; -webkit-line-clamp: 4;
    -webkit-box-orient: vertical; overflow: hidden;
  }

  .timeline-card-time {
    font-size: 0.72rem; color: var(--text-muted);
    margin-top: 8px;
  }

  .timeline-empty {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; padding: 60px 20px; text-align: center;
  }
  .timeline-empty h3 {
    font-size: 1.15rem; font-weight: 700; color: var(--text-secondary);
    margin-bottom: 6px;
  }
  .timeline-empty p { font-size: 0.92rem; color: var(--text-muted); }

  /* ── Browse View ── */
  .browse-view {
    padding: 16px 20px calc(var(--safe-bottom) + 20px);
  }

  .ideas-list { display: flex; flex-direction: column; gap: 12px; }

  .idea-card {
    background: var(--white); border-radius: var(--radius);
    padding: 16px; box-shadow: var(--shadow-sm);
    animation: card-in 0.3s ease-out;
    position: relative;
  }
  @keyframes card-in {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .idea-card-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px;
  }
  .idea-meta {
    display: flex; align-items: center; gap: 6px;
    font-size: 0.78rem; color: var(--text-muted);
  }
  .idea-source-icon { width: 16px; height: 16px; opacity: 0.5; }
  .idea-card-text {
    font-size: 0.98rem; line-height: 1.55; color: var(--text-primary);
    white-space: pre-wrap; word-break: break-word;
  }

  .delete-btn {
    width: 32px; height: 32px; border-radius: 8px;
    border: none; background: transparent; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: var(--text-muted); transition: all 0.15s;
    flex-shrink: 0;
  }
  .delete-btn:active { background: var(--red-light); color: var(--red); }

  /* Empty State */
  .empty-state {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; padding: 60px 20px; text-align: center;
  }
  .empty-state svg { width: 80px; height: 80px; margin-bottom: 16px; opacity: 0.3; }
  .empty-state h3 {
    font-size: 1.15rem; font-weight: 700; color: var(--text-secondary);
    margin-bottom: 6px;
  }
  .empty-state p { font-size: 0.92rem; color: var(--text-muted); }

  /* Toast */
  .toast {
    position: fixed; bottom: calc(var(--safe-bottom) + 24px);
    left: 50%; transform: translateX(-50%) translateY(80px);
    background: var(--text-primary); color: var(--white);
    padding: 12px 24px; border-radius: 50px;
    font-size: 0.9rem; font-weight: 600;
    box-shadow: var(--shadow-lg); z-index: 300;
    opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Confirm overlay */
  .confirm-overlay {
    position: fixed; inset: 0; z-index: 250;
    background: rgba(0,0,0,0.35);
    display: flex; align-items: center; justify-content: center;
    padding: 20px; opacity: 0; pointer-events: none;
    transition: opacity 0.2s;
  }
  .confirm-overlay.show { opacity: 1; pointer-events: auto; }
  .confirm-box {
    background: var(--white); border-radius: var(--radius);
    padding: 24px; max-width: 320px; width: 100%;
    box-shadow: var(--shadow-lg); text-align: center;
  }
  .confirm-box h3 { font-size: 1.1rem; margin-bottom: 6px; }
  .confirm-box p { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 20px; }
  .confirm-actions { display: flex; gap: 10px; }
  .confirm-actions button {
    flex: 1; padding: 12px; border-radius: var(--radius-sm);
    font-size: 0.95rem; font-weight: 600; border: none; cursor: pointer;
  }
  .cancel-btn { background: var(--cream-dark); color: var(--text-secondary); }
  .danger-btn { background: var(--red); color: var(--white); }
</style>
</head>
<body>

<!-- Auth Gate -->
<div class="auth-gate" id="authGate">
  <svg class="auth-logo" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="45" fill="rgba(255,255,255,0.2)"/>
    <path d="M50 15 C52 30, 65 35, 70 50 C72 58, 65 70, 50 80 C35 70, 28 58, 30 50 C35 35, 48 30, 50 15Z" fill="white" opacity="0.9"/>
    <path d="M50 25 C51 35, 58 38, 62 48 C63 53, 59 60, 50 68 C41 60, 37 53, 38 48 C42 38, 49 35, 50 25Z" fill="#FCD34D"/>
    <circle cx="50" cy="48" r="5" fill="#F97316" opacity="0.8"/>
  </svg>
  <h1>Spark</h1>
  <p>Capture ideas instantly.<br>Never lose a thought again.</p>
  <button class="google-btn" id="googleSignIn">
    <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
    Sign in with Google
  </button>
</div>

<!-- App -->
<div class="app" id="app">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <svg class="header-logo" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M50 10 C52 28, 68 33, 75 50 C77 60, 68 73, 50 85 C32 73, 23 60, 25 50 C32 33, 48 28, 50 10Z" fill="white" opacity="0.9"/>
        <path d="M50 22 C51 33, 60 37, 64 48 C65 54, 60 63, 50 72 C40 63, 35 54, 36 48 C40 37, 49 33, 50 22Z" fill="#FCD34D"/>
      </svg>
      <h1>Spark</h1>
    </div>
    <div class="header-right">
      <button class="sign-out-btn" id="signOutBtn">Sign Out</button>
    </div>
  </div>

  <!-- Views -->
  <div class="views-container" id="viewsContainer">
    <div class="views-slider" id="viewsSlider">

      <!-- Timeline View -->
      <div class="view timeline-view" id="timelineView">
        <div class="timeline-header">
          <h2>Your Idea River</h2>
          <p>How your thinking evolved</p>
        </div>
        <div class="timeline-river" id="timelineRiver"></div>
      </div>

      <!-- Capture View -->
      <div class="view capture-view" id="captureView">
        <div class="capture-spacer-top"></div>
        <div class="capture-prompt">What's your <span>idea</span>?</div>
        <div class="capture-middle">
          <textarea class="idea-input" id="ideaInput" placeholder="Type your idea here..." maxlength="2000"></textarea>
          <div class="char-count" id="charCount">0 / 2,000</div>
          <button class="save-btn" id="saveBtn" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </svg>
            Save Spark
          </button>
        </div>
        <div class="capture-spacer-bottom"></div>
        <div class="capture-bottom">
          <button class="mic-btn" id="micBtn" title="Dictate">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
              <line x1="12" x2="12" y1="19" y2="22"/>
            </svg>
          </button>
          <span class="mic-label">Dictate</span>
        </div>
      </div>

      <!-- Browse View -->
      <div class="view browse-view" id="browseView">
        <div class="ideas-list" id="ideasList"></div>
      </div>

    </div>
  </div>
</div>

<!-- Save Success Overlay -->
<div class="save-success" id="saveSuccess">
  <svg class="success-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="45" fill="url(#successGrad)"/>
    <path d="M30 52 L44 66 L70 36" stroke="white" stroke-width="7" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
    <defs><linearGradient id="successGrad" x1="0" y1="0" x2="100" y2="100">
      <stop offset="0%" stop-color="#F59E0B"/><stop offset="100%" stop-color="#F97316"/>
    </linearGradient></defs>
  </svg>
  <div class="success-text">Spark saved!</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Delete Confirm -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3>Delete this spark?</h3>
    <p>This can't be undone.</p>
    <div class="confirm-actions">
      <button class="cancel-btn" id="confirmCancel">Keep</button>
      <button class="danger-btn" id="confirmDelete">Delete</button>
    </div>
  </div>
</div>

<!-- Firebase SDK (compat for simpler API) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
(function() {
  'use strict';

  // ─── Firebase Config ───────────────────────────────────────
  // TODO: Replace with your Firebase project config
  const firebaseConfig = {
    apiKey: "AIzaSyBTMx2kpwILRsmMsFQTWu7vSXFqC9UlYLI",
    authDomain: "spark-593eb.firebaseapp.com",
    projectId: "spark-593eb",
    storageBucket: "spark-593eb.firebasestorage.app",
    messagingSenderId: "558545646481",
    appId: "1:558545646481:web:3d40b82b2015a0ad966030"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Persist auth across sessions
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

  // Enable offline persistence for Firestore
  db.enablePersistence({ synchronizeTabs: true }).catch(() => {});

  // ─── DOM Refs ──────────────────────────────────────────────
  const authGate = document.getElementById('authGate');
  const googleSignIn = document.getElementById('googleSignIn');
  const app = document.getElementById('app');
  const signOutBtn = document.getElementById('signOutBtn');
  const viewsContainer = document.getElementById('viewsContainer');
  const viewsSlider = document.getElementById('viewsSlider');
  const ideaInput = document.getElementById('ideaInput');
  const charCount = document.getElementById('charCount');
  const micBtn = document.getElementById('micBtn');
  const saveBtn = document.getElementById('saveBtn');
  const ideasList = document.getElementById('ideasList');
  const toast = document.getElementById('toast');
  const confirmOverlay = document.getElementById('confirmOverlay');
  const confirmCancel = document.getElementById('confirmCancel');
  const confirmDelete = document.getElementById('confirmDelete');

  // ─── State ─────────────────────────────────────────────────
  let currentUser = null;
  let currentView = 'capture'; // 'timeline' | 'capture' | 'browse'
  let ideas = [];
  let unsubFirestore = null;
  let recognition = null;
  let isRecording = false;
  let deleteTargetId = null;
  let toastTimeout = null;

  // ─── Auth ──────────────────────────────────────────────────
  googleSignIn.addEventListener('click', () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => {
      if (err.code !== 'auth/popup-closed-by-user') {
        showToast('Sign-in failed. Try again.');
      }
    });
  });

  signOutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      authGate.classList.add('hidden');
      app.classList.add('active');
      subscribeToIdeas();
      loadCachedIdeas();
    } else {
      authGate.classList.remove('hidden');
      app.classList.remove('active');
      if (unsubFirestore) { unsubFirestore(); unsubFirestore = null; }
      ideas = [];
      renderIdeas();
    }
  });

  // ─── Firestore ─────────────────────────────────────────────
  function ideasRef() {
    return db.collection('users').doc(currentUser.uid).collection('ideas');
  }

  function subscribeToIdeas() {
    if (unsubFirestore) unsubFirestore();
    unsubFirestore = ideasRef()
      .orderBy('createdAt', 'desc')
      .onSnapshot(snapshot => {
        ideas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        cacheIdeas();
        renderIdeas();
      }, err => {
        console.error('Firestore listen error:', err);
      });
  }

  function saveIdea(text, source) {
    return ideasRef().add({
      text: text.trim(),
      source: source,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  function deleteIdea(id) {
    return ideasRef().doc(id).delete();
  }

  // Local cache
  function cacheIdeas() {
    try {
      const cacheable = ideas.map(i => ({
        id: i.id, text: i.text, source: i.source,
        createdAt: i.createdAt ? i.createdAt.toMillis() : Date.now()
      }));
      localStorage.setItem('spark_ideas', JSON.stringify(cacheable));
    } catch(e) {}
  }

  function loadCachedIdeas() {
    try {
      const cached = JSON.parse(localStorage.getItem('spark_ideas') || '[]');
      if (cached.length && !ideas.length) {
        ideas = cached.map(i => ({
          ...i,
          createdAt: { toMillis: () => i.createdAt, toDate: () => new Date(i.createdAt) }
        }));
        renderIdeas();
      }
    } catch(e) {}
  }

  // ─── Save ──────────────────────────────────────────────────
  ideaInput.addEventListener('input', () => {
    const len = ideaInput.value.trim().length;
    saveBtn.disabled = len === 0;
    charCount.textContent = `${ideaInput.value.length.toLocaleString()} / 2,000`;
  });

  saveBtn.addEventListener('click', async () => {
    const text = ideaInput.value.trim();
    if (!text || !currentUser) return;

    saveBtn.disabled = true;
    saveBtn.classList.add('saving');

    const source = isRecording ? 'voice' : 'web';
    if (isRecording) stopRecording();

    try {
      await saveIdea(text, source);
      haptic();

      // Show success overlay
      const captureMiddle = document.querySelector('.capture-middle');
      const saveSuccess = document.getElementById('saveSuccess');

      // Fade out the workspace
      captureMiddle.classList.add('reset');

      // Show success animation
      saveSuccess.classList.remove('fade-out');
      saveSuccess.classList.add('show');

      setTimeout(() => {
        // Clear the fields while hidden
        ideaInput.value = '';
        charCount.textContent = '0 / 2,000';
        saveBtn.disabled = true;

        // Fade out success overlay
        saveSuccess.classList.add('fade-out');

        // Prep workspace to slide in from below
        captureMiddle.classList.remove('reset');
        captureMiddle.classList.add('reset-in');

        setTimeout(() => {
          saveSuccess.classList.remove('show', 'fade-out');
          // Animate workspace back in
          captureMiddle.classList.remove('reset-in');
          captureMiddle.classList.add('reset-done');

          setTimeout(() => {
            captureMiddle.classList.remove('reset-done');
          }, 350);
        }, 500);
      }, 1000);

    } catch(err) {
      showToast('Failed to save. Try again.');
      saveBtn.disabled = false;
    }

    setTimeout(() => saveBtn.classList.remove('saving'), 400);
  });

  // ─── Delete ────────────────────────────────────────────────
  function promptDelete(id) {
    deleteTargetId = id;
    confirmOverlay.classList.add('show');
  }

  confirmCancel.addEventListener('click', () => {
    confirmOverlay.classList.remove('show');
    deleteTargetId = null;
  });

  confirmDelete.addEventListener('click', async () => {
    if (!deleteTargetId) return;
    confirmOverlay.classList.remove('show');
    try {
      await deleteIdea(deleteTargetId);
      haptic();
      showToast('Spark deleted');
    } catch(err) {
      showToast('Failed to delete');
    }
    deleteTargetId = null;
  });

  confirmOverlay.addEventListener('click', (e) => {
    if (e.target === confirmOverlay) {
      confirmOverlay.classList.remove('show');
      deleteTargetId = null;
    }
  });

  // ─── Timeline Rendering ─────────────────────────────────────
  const timelineRiver = document.getElementById('timelineRiver');

  function renderTimeline() {
    // Show ideas oldest first for timeline flow
    const sorted = [...ideas].reverse();

    if (!sorted.length) {
      timelineRiver.innerHTML = `
        <div class="timeline-empty">
          <h3>No ideas yet</h3>
          <p>Swipe left to capture your first spark.</p>
        </div>`;
      return;
    }

    timelineRiver.innerHTML = sorted.map((idea, i) => {
      const date = idea.createdAt
        ? (idea.createdAt.toDate ? idea.createdAt.toDate() : new Date(idea.createdAt.toMillis()))
        : new Date();
      const timeStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
        + ' · ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

      return `
        <div class="timeline-item" style="animation-delay: ${i * 0.06}s">
          <div class="timeline-dot"></div>
          <div class="timeline-card">
            <div class="timeline-card-text">${escapeHtml(idea.text)}</div>
            <div class="timeline-card-time">${timeStr}</div>
          </div>
        </div>`;
    }).join('');
  }

  // ─── Browse View Rendering ─────────────────────────────────
  function renderIdeas() {
    if (!ideas.length) {
      ideasList.innerHTML = `
        <div class="empty-state">
          <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M50 10 C52 28, 68 33, 75 50 C77 60, 68 73, 50 85 C32 73, 23 60, 25 50 C32 33, 48 28, 50 10Z" fill="#D6D3D1"/>
            <path d="M50 22 C51 33, 60 37, 64 48 C65 54, 60 63, 50 72 C40 63, 35 54, 36 48 C40 37, 49 33, 50 22Z" fill="#E7E5E4"/>
          </svg>
          <h3>No ideas yet</h3>
          <p>Swipe right to capture your first idea.</p>
        </div>`;
      return;
    }

    ideasList.innerHTML = ideas.map(idea => {
      const time = idea.createdAt
        ? timeAgo(idea.createdAt.toDate ? idea.createdAt.toDate() : new Date(idea.createdAt.toMillis()))
        : 'just now';
      const sourceIcon = idea.source === 'voice' ? micSvg() : (idea.source === 'email' ? emailSvg() : webSvg());
      return `
        <div class="idea-card" data-id="${idea.id}">
          <div class="idea-card-header">
            <div class="idea-meta">${sourceIcon}<span>${time}</span></div>
            <button class="delete-btn" onclick="window._deleteSpark('${idea.id}')" title="Delete">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            </button>
          </div>
          <div class="idea-card-text">${escapeHtml(idea.text)}</div>
        </div>`;
    }).join('');
  }

  window._deleteSpark = promptDelete;

  function escapeHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
  }

  function micSvg() {
    return `<svg class="idea-source-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>`;
  }
  function webSvg() {
    return `<svg class="idea-source-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>`;
  }
  function emailSvg() {
    return `<svg class="idea-source-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>`;
  }

  function timeAgo(date) {
    const secs = Math.floor((Date.now() - date.getTime()) / 1000);
    if (secs < 5) return 'just now';
    if (secs < 60) return `${secs}s ago`;
    const mins = Math.floor(secs / 60);
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    const days = Math.floor(hrs / 24);
    if (days < 30) return `${days}d ago`;
    const months = Math.floor(days / 30);
    if (months < 12) return `${months}mo ago`;
    return `${Math.floor(months / 12)}y ago`;
  }

  // ─── View Switching (3 panels: timeline | capture | browse) ──
  // Positions: timeline = 0%, capture = -33.333%, browse = -66.666%
  const viewPositions = { timeline: 0, capture: -33.333, browse: -66.666 };

  function switchView(view) {
    currentView = view;
    viewsSlider.style.transform = `translateX(${viewPositions[view]}%)`;
    if (view === 'timeline') renderTimeline();
  }

  // ─── Swipe Gestures ────────────────────────────────────────
  let touchStartX = 0;
  let touchStartY = 0;
  let touchDeltaX = 0;
  let isSwiping = false;
  let swipeLocked = false;

  const viewOrder = ['timeline', 'capture', 'browse'];

  viewsContainer.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    touchDeltaX = 0;
    isSwiping = false;
    swipeLocked = false;
  }, { passive: true });

  viewsContainer.addEventListener('touchmove', (e) => {
    const dx = e.touches[0].clientX - touchStartX;
    const dy = e.touches[0].clientY - touchStartY;

    if (!isSwiping && !swipeLocked) {
      if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 10) {
        swipeLocked = true;
        return;
      }
      if (Math.abs(dx) > 10) {
        isSwiping = true;
        viewsSlider.classList.add('swiping');
      }
    }

    if (swipeLocked) return;
    if (!isSwiping) return;

    touchDeltaX = dx;
    const base = viewPositions[currentView];
    const pct = base + (dx / viewsContainer.offsetWidth) * 33.333;
    const clamped = Math.max(-66.666, Math.min(0, pct));
    viewsSlider.style.transform = `translateX(${clamped}%)`;
  }, { passive: true });

  viewsContainer.addEventListener('touchend', () => {
    if (!isSwiping) return;
    viewsSlider.classList.remove('swiping');

    const threshold = viewsContainer.offsetWidth * 0.2;
    const idx = viewOrder.indexOf(currentView);

    if (touchDeltaX < -threshold && idx < viewOrder.length - 1) {
      switchView(viewOrder[idx + 1]);
    } else if (touchDeltaX > threshold && idx > 0) {
      switchView(viewOrder[idx - 1]);
    } else {
      switchView(currentView);
    }
  }, { passive: true });

  // ─── Timeline Pinch-to-Zoom ─────────────────────────────────
  const timelineView = document.getElementById('timelineView');
  let tlScale = 1;
  let tlPinchStartDist = 0;
  let tlPinchStartScale = 1;

  timelineView.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      tlPinchStartDist = Math.hypot(
        e.touches[1].clientX - e.touches[0].clientX,
        e.touches[1].clientY - e.touches[0].clientY
      );
      tlPinchStartScale = tlScale;
    }
  }, { passive: true });

  timelineView.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
      const dist = Math.hypot(
        e.touches[1].clientX - e.touches[0].clientX,
        e.touches[1].clientY - e.touches[0].clientY
      );
      const ratio = dist / tlPinchStartDist;
      tlScale = Math.min(3, Math.max(0.4, tlPinchStartScale * ratio));
      timelineRiver.style.transform = `scale(${tlScale})`;
      timelineRiver.style.transformOrigin = 'top center';
    }
  }, { passive: true });

  // ─── Voice Input ───────────────────────────────────────────
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    micBtn.classList.add('unsupported');
    micBtn.title = 'Voice input not supported in this browser';
  }

  micBtn.addEventListener('click', () => {
    if (!SpeechRecognition) return;
    if (isRecording) {
      stopRecording();
    } else {
      startRecording();
    }
  });

  function startRecording() {
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    let finalTranscript = ideaInput.value;
    const startingText = finalTranscript;

    recognition.onresult = (event) => {
      let interim = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const t = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalTranscript += (finalTranscript && !finalTranscript.endsWith(' ') ? ' ' : '') + t;
        } else {
          interim += t;
        }
      }
      ideaInput.value = finalTranscript + (interim ? (finalTranscript && !finalTranscript.endsWith(' ') ? ' ' : '') + interim : '');
      saveBtn.disabled = ideaInput.value.trim().length === 0;
      charCount.textContent = `${ideaInput.value.length.toLocaleString()} / 2,000`;
    };

    recognition.onerror = (event) => {
      if (event.error !== 'no-speech' && event.error !== 'aborted') {
        showToast('Voice error: ' + event.error);
      }
      stopRecording();
    };

    recognition.onend = () => {
      if (isRecording) {
        // Auto-stopped, restart for continuous listening
        try { recognition.start(); } catch(e) { stopRecording(); }
      }
    };

    try {
      recognition.start();
      isRecording = true;
      micBtn.classList.add('recording');
      haptic();
    } catch(e) {
      showToast('Could not start voice input');
    }
  }

  function stopRecording() {
    isRecording = false;
    micBtn.classList.remove('recording');
    if (recognition) {
      try { recognition.stop(); } catch(e) {}
      recognition = null;
    }
  }

  // ─── Spark Burst Animation ─────────────────────────────────
  function sparkBurst(anchor) {
    const rect = anchor.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;

    const container = document.createElement('div');
    container.className = 'spark-burst';
    container.style.left = cx + 'px';
    container.style.top = cy + 'px';

    const colors = ['#F59E0B', '#F97316', '#EC4899', '#FCD34D', '#FB923C'];
    const count = 14;

    for (let i = 0; i < count; i++) {
      const p = document.createElement('div');
      p.className = 'spark-particle';
      const angle = (Math.PI * 2 * i) / count + (Math.random() - 0.5) * 0.5;
      const dist = 40 + Math.random() * 50;
      const size = 4 + Math.random() * 6;
      p.style.width = size + 'px';
      p.style.height = size + 'px';
      p.style.background = colors[Math.floor(Math.random() * colors.length)];
      p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
      p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
      container.appendChild(p);
    }

    document.body.appendChild(container);
    setTimeout(() => container.remove(), 800);
  }

  // ─── Haptic ────────────────────────────────────────────────
  function haptic() {
    if (navigator.vibrate) navigator.vibrate(10);
  }

  // ─── Toast ─────────────────────────────────────────────────
  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => toast.classList.remove('show'), 2200);
  }

})();
</script>
</body>
</html>
